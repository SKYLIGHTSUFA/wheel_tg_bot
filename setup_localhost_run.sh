#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ localhost.run —Ç—É–Ω–Ω–µ–ª—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./setup_localhost_run.sh

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ localhost.run —Ç—É–Ω–Ω–µ–ª—è..."
echo ""
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç SSH —Ç—É–Ω–Ω–µ–ª—å —á–µ—Ä–µ–∑ localhost.run"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ –±–æ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8000
if lsof -Pi :8000 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚úÖ –ü–æ—Ä—Ç 8000 —É–∂–µ –∑–∞–Ω—è—Ç (–±–æ—Ç, –≤–µ—Ä–æ—è—Ç–Ω–æ, –∑–∞–ø—É—â–µ–Ω)"
else
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 8000 —Å–≤–æ–±–æ–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç—É–Ω–Ω–µ–ª—è."
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo ""
echo "üì° –°–æ–∑–¥–∞–Ω–∏–µ SSH —Ç—É–Ω–Ω–µ–ª—è —á–µ—Ä–µ–∑ localhost.run..."
echo "   –ö–æ–º–∞–Ω–¥–∞: ssh -R 80:localhost:8000 ssh.localhost.run"
echo ""
echo "–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ URL –≤–∏–¥–∞: https://xxxxx.localhost.run"
echo "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç URL –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
echo "   export WEBAPP_URL=https://xxxxx.localhost.run"
echo ""
echo "–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª:"
echo "   WEBAPP_URL=https://xxxxx.localhost.run"
echo ""
echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—è"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å
ssh -R 80:localhost:8000 ssh.localhost.run
